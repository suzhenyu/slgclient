# 地图系统整体架构

这个地图系统采用了经典的MVC架构，核心设计理念是数据驱动和按需加载：

## 1. 核心设计思想

- **数据驱动**: 地图上的所有元素（地形、资源、城市、建筑）都由数据决定，渲染层只负责可视化
- **按需加载**: 将大地图分割成区域，只加载玩家视野内的区域，实现性能优化

## 2. 主要组件分层

### Controller层:
```
├── MapCommand.ts (命令中心，单例)
├── MapLogic.ts (用户交互控制)
└── MapScene.ts (场景总控制器)
```

### Model层:
```
├── MapProxy.ts (地图数据代理)
├── MapCityProxy.ts (城市数据代理)
└── MapBuildProxy.ts (建筑数据代理)
```

### View层:
```
├── MapBaseLayerLogic.ts (视图基类)
├── MapResLogic.ts (资源点渲染)
├── MapCityLogic.ts (城市渲染)
├── MapResBuildLogic.ts (建筑渲染)
└── 其他具体渲染逻辑...
```

### Utils:
```
├── MapUtil.ts (坐标转换工具)
└── MapTouchLogic.ts (触摸处理)
```

## 核心工作流程

### 1. 地图初始化流程

```javascript
// 1. MapScene 初始化
MapScene.onLoad() {
    // 创建TiledMap组件，加载.tmx文件
    // 初始化MapUtil配置
    // 初始化MapCommand数据
    // 滚动到玩家主城位置
}

// 2. 数据初始化
MapCommand.initData() {
    // 初始化各个Proxy
    // 请求服务器数据
}
```

### 2. 区域加载机制

这是系统的核心优化机制：
```javascript
// 地图被划分为多个区域(Area)
// 每个区域包含 N×N 个格子
// 只加载玩家视野周围的9个区域(3×3九宫格)

MapProxy.setCurCenterPoint() {
    // 1. 计算当前中心点所在区域
    // 2. 计算九宫格可见区域
    // 3. 对比新旧区域，得出需要加载/卸载的区域
    // 4. 派发mapShowAreaChange事件
}
```

### 3. 视图更新流程

```javascript
// 当区域变化时，所有Logic组件响应
onMapShowAreaChange(addIds, removeIds) {
    // 1. 卸载removeIds区域的节点到对象池
    // 2. 从addIds区域加载新节点
    // 3. 根据数据设置节点外观和位置
}
```

## 坐标系统

系统定义了三种坐标系：
1. **地图格子坐标**: 逻辑网格坐标 (x, y)
2. **地图像素坐标**: 相对于地图节点的像素坐标
3. **世界像素坐标**: Cocos Creator场景全局坐标

`MapUtil.ts` 提供了这些坐标系之间的转换方法。

## 数据管理

### 1. 静态数据

- `.tmx`文件：地图基础布局
- `mapRes_0.json`：每个格子的资源类型和等级

### 2. 动态数据

- 通过服务器请求获取
- 包括玩家建筑、城市、军队等实时数据

## 性能优化策略

### 1. 对象池管理

所有地图实体都使用NodePool进行复用，避免频繁创建/销毁节点

### 2. 区域分割加载

只渲染可见区域，大幅减少内存和CPU开销

### 3. 事件驱动更新

使用事件系统解耦各模块，按需更新

## 交互处理

### 1. 地图拖拽

```javascript
MapLogic.onTouchMove() {
    // 更新相机位置
    // 触发区域变化检测
    // 更新可见区域
}
```

### 2. 点击处理

```javascript
MapTouchLogic.onTouchMap() {
    // 坐标转换
    // 判断点击对象类型(城市/建筑/资源)
    // 显示相应UI
}
```

## 关键优势

1. **可扩展性强**: MVC架构便于添加新功能
2. **性能优异**: 区域加载机制支持超大地图
3. **代码复用**: 基类设计减少重复代码
4. **数据驱动**: 便于配置和调试

这个地图系统是一个非常成熟的工程实践，特别适合大型SLG游戏。如果你要开发类似项目，建议重点学习其区域加载机制和MVC架构设计。